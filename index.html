<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üé• Youtube Viewer - N√¢ng Cao</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 24px;
      background: #fffbeb;
      color: #333;
    }
    #main-container {
      max-width: 1100px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 24px;
    }
    h1 {
      text-align: center;
      color: #8B0000;
      margin-bottom: 8px;
    }
    #mode-status {
      text-align: center;
      margin: 12px 0 8px 0;
      color: #a13c3c;
    }
    #layout-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    #playlist-column {
      flex: 1;
      min-width: 280px;
      max-width: 350px;
    }
    #player-column {
      flex: 2;
      min-width: 400px;
    }
    #search-box {
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 6px;
      font-size: 16px;
    }
    #song-list {
      max-height: 66vh;
      overflow-y: auto;
      border: 1px solid #f3f3f3;
      border-radius: 8px;
      background: #fffef8;
      padding: 0;
    }
    #song-list li {
      list-style: none;
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    #song-list li.playing {
      background: #fff9e6;
      font-weight: bold;
      color: #8B0000;
    }
    #song-list li:last-child { border-bottom: none; }
    #player {
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
    }
    #player-controls {
      margin-top: 12px;
      text-align: center;
    }
    .player-button {
      margin: 4px;
      padding: 8px 16px;
      background: #8B0000;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      transition: background 0.2s;
    }
    .player-button.active {
      background: #005f5f;
    }
    .player-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .thumb {
      width: 38px;
      height: 24px;
      border-radius: 5px;
      object-fit: cover;
      margin-right: 4px;
      box-shadow: 0 0 4px #8882;
    }
    @media (max-width: 900px) {
      #layout-container { flex-direction: column; }
      #playlist-column, #player-column { max-width: 100%; min-width: 0; }
    }
  </style>
</head>
<body>
  <div id="main-container">
    <h1>üé• Tr√¨nh Xem Youtube N√¢ng Cao</h1>
    <div id="mode-status">Ch·∫ø ƒë·ªô: B√¨nh th∆∞·ªùng</div>
    <div id="layout-container">
      <div id="playlist-column">
        <input id="search-box" type="text" placeholder="T√¨m ki·∫øm b√†i h√°t..." />
        <ul id="song-list"></ul>
      </div>
      <div id="player-column">
        <div id="player"></div>
        <div id="player-controls">
          <button class="player-button" id="prev-button" title="L√πi">‚èÆ</button>
          <button class="player-button" id="next-button" title="Ti·∫øp">‚è≠</button>
          <button class="player-button" id="shuffle-button" title="Ng·∫´u nhi√™n">üîÄ</button>
          <button class="player-button" id="repeat-button" title="L·∫∑p 1 b√†i">üîÇ</button>
          <button class="player-button" id="repeatall-button" title="L·∫∑p to√†n b·ªô">üîÅ</button>
          <button class="player-button" id="pip-button" title="PIP">ü™ü</button>
        </div>
        <!-- √Çm thanh n·ªÅn b√≠ m·∫≠t ƒë·ªÉ gi·ªØ ph√°t khi t·∫Øt m√†n h√¨nh -->
        <audio id="background-audio" src="https://cdn.pixabay.com/audio/2022/11/16/audio_12dbd6534b.mp3" preload="auto" loop style="display:none"></audio>
      </div>
    </div>
  </div>
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // ====== C·∫§U H√åNH ======
    const apiEndpoint = 'https://api.sheetbest.com/sheets/276c7c77-e2f0-4726-9929-7c4848f276bb';

    // ====== BI·∫æN QU·∫¢N L√ù ======
    let youtubePlayer;
    let isShuffle = false;
    let isRepeatOne = false;
    let isRepeatAll = false;
    let shufflePlayed = new Set();
    let playlist = [];
    let currentIndex = 0;

    // ====== HI·ªÇN TH·ªä TR·∫†NG TH√ÅI CH·∫æ ƒê·ªò ======
    function updateModeStatus() {
      let mode = 'B√¨nh th∆∞·ªùng';
      if (isRepeatOne) mode = 'L·∫∑p 1 b√†i';
      else if (isRepeatAll && isShuffle) mode = 'L·∫∑p to√†n b·ªô + Ng·∫´u nhi√™n';
      else if (isRepeatAll) mode = 'L·∫∑p to√†n b·ªô';
      else if (isShuffle) mode = 'Ng·∫´u nhi√™n';
      document.getElementById('mode-status').textContent = 'Ch·∫ø ƒë·ªô: ' + mode;
    }

    // ====== L·ªåC & HI·ªÇN TH·ªä DANH S√ÅCH PH√ÅT ======
    function renderSongList(data, filter='') {
      const list = document.getElementById('song-list');
      list.innerHTML = '';
      playlist = [];
      data.forEach((item, idx) => {
        const title = item["T√™n B√†i H√°t"]?.trim();
        const videoId = item["M√£ Video"]?.trim();
        if (!title || !videoId) return;
        if (filter && !title.toLowerCase().includes(filter.toLowerCase())) return;
        playlist.push({ title, videoId });
        const li = document.createElement('li');
        li.textContent = `${playlist.length}. ${title}`;
        li.dataset.videoId = videoId;
        li.dataset.idx = playlist.length - 1;
        // Thumbnails ƒë·∫πp maxresdefault
        const img = document.createElement('img');
        img.className = 'thumb';
        img.src = `https://i.ytimg.com/vi/${videoId}/maxresdefault.jpg`;
        img.onerror = function() { this.src = `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`; };
        li.prepend(img);
        list.appendChild(li);
      });
      if (playlist.length > 0) {
        selectSong(0);
      }
    }

    // ====== T√åM KI·∫æM ======
    document.getElementById('search-box').addEventListener('input', function() {
      fetchAndShow(this.value);
    });

    // ====== C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI DANH S√ÅCH ======
    function highlightPlaying(idx) {
      const lis = document.querySelectorAll('#song-list li');
      lis.forEach(li => li.classList.remove('playing'));
      if (lis[idx]) lis[idx].classList.add('playing');
      // Scroll v√†o trung t√¢m khi ch·ªçn
      if (lis[idx]) lis[idx].scrollIntoView({ block: 'nearest', behavior: 'smooth' });
    }

    // ====== X·ª¨ L√ù CH·ªåN & PH√ÅT VIDEO ======
    function selectSong(idx, startTime=0) {
      currentIndex = idx;
      highlightPlaying(idx);
      const { videoId, title } = playlist[idx];
      playVideo(videoId, title, startTime);
    }

    function playVideo(videoId, title, startTime=0) {
      // Update MediaSession
      updateMediaSession(title, videoId);
      // Play tr√™n youtube iframe
      if (youtubePlayer && youtubePlayer.loadVideoById) {
        youtubePlayer.loadVideoById({ videoId, startSeconds: startTime });
      } else {
        youtubePlayer = new YT.Player('player', {
          videoId,
          playerVars: { autoplay: 1, rel: 0 },
          events: {
            onReady: (e) => e.target.playVideo(),
            onStateChange: onPlayerStateChange,
          }
        });
      }
    }

    // ====== X·ª¨ L√ù PH√ÅT XONG ======
    function onPlayerStateChange(event) {
      // Khi k·∫øt th√∫c video
      if (event.data === YT.PlayerState.ENDED) {
        if (isRepeatOne) {
          selectSong(currentIndex);
        } else if (isShuffle) {
          let nextIdx = getRandomUnplayedIndex();
          if (nextIdx === null) {
            shufflePlayed.clear();
            nextIdx = getRandomUnplayedIndex();
          }
          if (nextIdx !== null) {
            selectSong(nextIdx);
            shufflePlayed.add(playlist[nextIdx].videoId);
          }
        } else if (currentIndex < playlist.length - 1) {
          selectSong(currentIndex + 1);
        } else if (isRepeatAll) {
          selectSong(0);
        }
      }
    }

    // ====== L·∫§Y RANDOM CH∆ØA PH√ÅT (SHUFFLE) ======
    function getRandomUnplayedIndex() {
      const unplayed = playlist
        .map((item, idx) => (!shufflePlayed.has(item.videoId) ? idx : null))
        .filter(idx => idx !== null && idx !== currentIndex);
      if (unplayed.length === 0) return null;
      const nextIdx = unplayed[Math.floor(Math.random() * unplayed.length)];
      return nextIdx;
    }

    // ====== C·∫¨P NH·∫¨T MEDIA SESSION ======
    function updateMediaSession(title, videoId) {
      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: title,
          artist: 'Youtube Playlist',
          album: 'Danh s√°ch ph√°t',
          artwork: [
            { src: `https://i.ytimg.com/vi/${videoId}/maxresdefault.jpg`, sizes: '1280x720', type: 'image/jpeg' },
            { src: `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg`, sizes: '320x180', type: 'image/jpeg' }
          ]
        });
        navigator.mediaSession.setActionHandler('play', () => youtubePlayer.playVideo());
        navigator.mediaSession.setActionHandler('pause', () => youtubePlayer.pauseVideo());
        navigator.mediaSession.setActionHandler('previoustrack', () => {
          if (currentIndex > 0) selectSong(currentIndex - 1);
        });
        navigator.mediaSession.setActionHandler('nexttrack', () => {
          if (currentIndex < playlist.length - 1) selectSong(currentIndex + 1);
          else if (isRepeatAll) selectSong(0);
        });
      }
    }

    // ====== FETCH V√Ä HI·ªÇN TH·ªä DANH S√ÅCH ======
    function fetchAndShow(filter='') {
      fetch(apiEndpoint)
        .then(res => res.ok ? res.json() : Promise.reject('L·ªói t·∫£i d·ªØ li·ªáu'))
        .then(data => renderSongList(data, filter))
        .catch(() => {
          document.getElementById('song-list').innerHTML = '<li>L·ªói t·∫£i d·ªØ li·ªáu</li>';
        });
    }

    // ====== DOMContentLoaded ======
    document.addEventListener('DOMContentLoaded', () => {
      fetchAndShow();

      // Click b√†i h√°t
      document.getElementById('song-list').onclick = function(e) {
        let li = e.target.closest('li');
        if (!li) return;
        const idx = Number(li.dataset.idx);
        selectSong(idx);
      };

      // ƒêi·ªÅu khi·ªÉn n√∫t
      document.getElementById('next-button').onclick = () => {
        if (currentIndex < playlist.length - 1) selectSong(currentIndex + 1);
        else if (isRepeatAll) selectSong(0);
      };
      document.getElementById('prev-button').onclick = () => {
        if (currentIndex > 0) selectSong(currentIndex - 1);
        else if (isRepeatAll) selectSong(playlist.length - 1);
      };
      document.getElementById('shuffle-button').onclick = function() {
        isShuffle = !isShuffle;
        this.classList.toggle('active');
        shufflePlayed.clear();
        updateModeStatus();
      };
      document.getElementById('repeat-button').onclick = function() {
        isRepeatOne = !isRepeatOne;
        this.classList.toggle('active');
        if (isRepeatOne) {
          isRepeatAll = false;
          document.getElementById('repeatall-button').classList.remove('active');
        }
        updateModeStatus();
      };
      document.getElementById('repeatall-button').onclick = function() {
        isRepeatAll = !isRepeatAll;
        this.classList.toggle('active');
        if (isRepeatAll) {
          isRepeatOne = false;
          document.getElementById('repeat-button').classList.remove('active');
        }
        updateModeStatus();
      };
      document.getElementById('pip-button').onclick = function() {
        enterPIP();
      };

      // ==== √ÇM THANH B√ç M·∫¨T GI·ªÆ PH√ÅT ====
      const bgAudio = document.getElementById('background-audio');
      document.body.addEventListener('click', () => {
        // ch·ªâ play khi user ƒë√£ c√≥ thao t√°c, ƒë·ªÉ kh√¥ng b·ªã block autoplay
        if (bgAudio.paused) {
          bgAudio.volume = 0.01; // c·ª±c nh·ªè
          bgAudio.play().catch(()=>{});
        }
      }, { once: true });
    });

    // ====== PIP ======
    function enterPIP() {
      const iframe = document.querySelector('#player iframe');
      if (iframe && 'requestPictureInPicture' in iframe) {
        iframe.requestPictureInPicture();
      } else if (iframe) {
        alert("PIP kh√¥ng h·ªó tr·ª£ tr·ª±c ti·∫øp cho Youtube iframe. B·∫°n c√≥ th·ªÉ click chu·ªôt ph·∫£i 2 l·∫ßn ƒë·ªÉ ch·ªçn '·∫¢nh trong ·∫£nh' (tr√™n Chrome).");
      }
    }
    window.onYouTubeIframeAPIReady = function() {};
  </script>
</body>
</html>
